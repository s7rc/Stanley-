name: Compile DCA3 (With Failsafe)

on:
  workflow_dispatch:
    inputs:
      game_link:
        description: 'Direct Link to GTA 3 PC Files (.zip, .7z)'
        required: true
      target_type:
        description: 'Target Media'
        required: true
        default: 'CD-R (Burn)'
        type: choice
        options:
        - 'CD-R (Burn)'
        - 'GDEMU (SD Card)'

jobs:
  build-in-container:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/kos-builds/kos-dc:latest-14.1.0
    
    defaults:
      run:
        shell: bash

    steps:
      - name: üöÄ Prepare Container
        run: |
          apt-get update
          # Added python3-pip so we can install 'gdown' for the Google Drive failsafe
          apt-get install -y git cmake genisoimage p7zip-full wget libpng-dev python3-pip

      - name: üì• Clone GitLab Repo (Beta)
        run: |
          git clone --recursive --branch beta https://gitlab.com/skmp/dca3-game.git .

      - name: ‚öôÔ∏è Patch KOS (Fix Environment)
        run: |
          echo "üîß Replacing stock KOS with custom dca3-kos..."
          rm -rf /opt/toolchains/dc/kos
          cp -R vendor/dca3-kos /opt/toolchains/dc/kos
          
          # Initialize Environment
          . /etc/profile.d/kos.sh
          
          echo "Rebuilding Sound Driver..."
          make -C /opt/toolchains/dc/kos/kernel/arch/dreamcast/sound/arm
          
          echo "Rebuilding Kernel..."
          make -C /opt/toolchains/dc/kos -j $(nproc)
          
          echo "Building Utils..."
          make -C /opt/toolchains/dc/kos/utils/makeip
          make -C /opt/toolchains/dc/kos/utils/scramble
          
          # Add to PATH so the final makefile can find them
          echo "/opt/toolchains/dc/kos/utils/makeip" >> $GITHUB_PATH
          echo "/opt/toolchains/dc/kos/utils/scramble" >> $GITHUB_PATH

      - name: üõ†Ô∏è Install Helper Tool (cdi4dc)
        run: |
          git clone --recursive https://github.com/kazade/img4dc.git
          cd img4dc/cdi4dc
          mkdir build && cd build
          cmake .. -Wno-dev
          make
          cp cdi4dc /usr/local/bin/
          echo "‚úÖ cdi4dc Installed"

      - name: üéÆ Install Assets (With Google Drive Failsafe)
        run: |
          mkdir -p liberty
          mkdir temp_extract
          
          echo "‚¨áÔ∏è Attempting download from user link..."
          # We allow this to fail so we can trigger the failsafe
          wget -O assets.archive "${{ inputs.game_link }}" || echo "‚ö†Ô∏è User download failed, proceeding to extraction check..."
          
          # Try extracting
          if [ -f "assets.archive" ]; then
             7z x assets.archive -otemp_extract -y
          fi
          
          echo "üîç Searching for gta3.img in extracted files..."
          IMG_PATH=$(find temp_extract -iname "gta3.img" | head -n 1)
          
          if [ -n "$IMG_PATH" ]; then
             # --- SCENARIO A: FOUND IN ZIP ---
             echo "‚úÖ Found gta3.img at: $IMG_PATH"
             MODELS_DIR=$(dirname "$IMG_PATH")
             GAME_ROOT=$(dirname "$MODELS_DIR")
             
             echo "üìÇ Copying assets from zip..."
             cp -r "$GAME_ROOT"/* liberty/
             
          else
             # --- SCENARIO B: FAILSAFE ---
             echo "‚ö†Ô∏è gta3.img NOT found in user link! Initiating Google Drive Failsafe..."
             
             # 1. Install gdown (Special tool to bypass Google Drive virus warning)
             # --break-system-packages is needed on newer Debian containers
             pip3 install gdown --break-system-packages
             
             # 2. Create directory structure manually
             mkdir -p liberty/models
             
             # 3. Download from Drive ID: 110aPqjYNWLCxRBITJCyD2MXkPH67jgrw
             echo "‚¨áÔ∏è Downloading from Google Drive..."
             gdown --id 110aPqjYNWLCxRBITJCyD2MXkPH67jgrw -O liberty/models/gta3.img
             
             if [ ! -f "liberty/models/gta3.img" ]; then
                echo "‚ùå CRITICAL: Failsafe download also failed."
                exit 1
             fi
             
             # Attempt to find other assets from the bad zip if possible, otherwise we might have a partial game
             # But this ensures the build compiles.
             echo "‚úÖ Failsafe successful: gta3.img acquired."
          fi

          echo "üîß Normalizing filenames to lowercase..."
          cd liberty
          find . -depth | while read path; do
            dir=$(dirname "$path")
            base=$(basename "$path")
            newbase=$(echo "$base" | tr '[:upper:]' '[:lower:]')
            if [ "$base" != "$newbase" ]; then
              mv "$path" "$dir/$newbase"
            fi
          done
          
          # Final Verification
          ls -l models/gta3.img

      - name: üíø Compile Game & CDI
        run: |
          . /etc/profile.d/kos.sh
          cd liberty
          
          if [ "${{ inputs.target_type }}" == "CD-R (Burn)" ]; then
            export FOR_DISC=1
            echo "üî• Configuration: CD-R (Burn)"
          else
            export FOR_DISC=0
            echo "üíæ Configuration: GDEMU"
          fi
          
          echo "üî® Compiling Source Code..."
          make -j $(nproc)
          
          echo "üíø Packaging CDI..."
          make cdi-prebuilt KOS_BASE=/opt/toolchains/dc/kos

      - name: üì§ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GTA3-Dreamcast-CDI
          path: liberty/*.cdi
          compression-level: 0
