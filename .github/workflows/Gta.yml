name: Compile DCA3 (Drive Default)

on:
  workflow_dispatch:
    inputs:
      game_link:
        description: 'Link to other game files (Audio/Data/etc)'
        required: true
      target_type:
        description: 'Target Media'
        required: true
        default: 'CD-R (Burn)'
        type: choice
        options:
        - 'CD-R (Burn)'
        - 'GDEMU (SD Card)'

jobs:
  build-in-container:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/kos-builds/kos-dc:latest-14.1.0
    
    defaults:
      run:
        shell: bash

    steps:
      - name: üöÄ Prepare Container
        run: |
          apt-get update
          apt-get install -y git cmake genisoimage p7zip-full wget libpng-dev python3-pip

      - name: üì• Clone GitLab Repo (Beta)
        run: |
          git clone --recursive --branch beta https://gitlab.com/skmp/dca3-game.git .

      - name: ‚öôÔ∏è Patch KOS (Fix Environment)
        run: |
          echo "üîß Replacing stock KOS with custom dca3-kos..."
          rm -rf /opt/toolchains/dc/kos
          cp -R vendor/dca3-kos /opt/toolchains/dc/kos
          
          # Initialize Environment
          . /etc/profile.d/kos.sh
          
          echo "Rebuilding Sound Driver..."
          make -C /opt/toolchains/dc/kos/kernel/arch/dreamcast/sound/arm
          
          echo "Rebuilding Kernel..."
          make -C /opt/toolchains/dc/kos -j $(nproc)
          
          echo "Building Utils..."
          make -C /opt/toolchains/dc/kos/utils/makeip
          make -C /opt/toolchains/dc/kos/utils/scramble
          
          # Add to PATH
          echo "/opt/toolchains/dc/kos/utils/makeip" >> $GITHUB_PATH
          echo "/opt/toolchains/dc/kos/utils/scramble" >> $GITHUB_PATH

      - name: üõ†Ô∏è Install Helper Tool (cdi4dc)
        run: |
          git clone --recursive https://github.com/kazade/img4dc.git
          cd img4dc/cdi4dc
          mkdir build && cd build
          cmake .. -Wno-dev
          make
          cp cdi4dc /usr/local/bin/
          echo "‚úÖ cdi4dc Installed"

      - name: üéÆ Install Assets (Googledrivedownloader)
        run: |
          # 1. Install the requested python library
          pip3 install googledrivedownloader requests --break-system-packages

          mkdir -p liberty
          mkdir temp_extract
          
          # 2. Extract User Files (Audio/Data/Text)
          echo "‚¨áÔ∏è Downloading user assets..."
          wget -O assets.archive "${{ inputs.game_link }}"
          7z x assets.archive -otemp_extract -y
          
          # Locate game root (Looking for 'data' or 'models' folders)
          GAME_ROOT=$(find temp_extract -type d -name "data" -printf "%h\n" | head -n 1)
          if [ -z "$GAME_ROOT" ]; then GAME_ROOT=$(find temp_extract -type d -name "models" -printf "%h\n" | head -n 1); fi
          
          if [ -z "$GAME_ROOT" ]; then
             echo "‚ùå Error: Could not find game structure (data/models folders) in your link."
             exit 1
          fi
          
          echo "üìÇ Copying base assets to liberty..."
          cp -r "$GAME_ROOT"/* liberty/

          # 3. Normalize Filenames (Linux is case sensitive)
          echo "üîß Normalizing filenames to lowercase..."
          cd liberty
          find . -depth | while read path; do
            dir=$(dirname "$path")
            base=$(basename "$path")
            newbase=$(echo "$base" | tr '[:upper:]' '[:lower:]')
            if [ "$base" != "$newbase" ]; then
              mv "$path" "$dir/$newbase"
            fi
          done
          cd ..
          
          # 4. DOWNLOAD gta3.img FROM DRIVE using googledrivedownloader
          echo "‚¨áÔ∏è Downloading gta3.img via Python..."
          mkdir -p liberty/models
          
          # Inline Python script to use the library
          python3 -c "from googledrivedownloader import download_file_from_google_drive; \
          print('Starting download...'); \
          download_file_from_google_drive(file_id='110aPqjYNWLCxRBITJCyD2MXkPH67jgrw', \
                                        dest_path='./liberty/models/gta3.img', \
                                        showsize=True); \
          print('Download complete.')"
          
          echo "‚úÖ Asset Setup Complete."
          ls -l liberty/models/gta3.img

      - name: üíø Compile Game & CDI
        run: |
          . /etc/profile.d/kos.sh
          cd liberty
          
          if [ "${{ inputs.target_type }}" == "CD-R (Burn)" ]; then
            export FOR_DISC=1
            echo "üî• Configuration: CD-R (Burn)"
          else
            export FOR_DISC=0
            echo "üíæ Configuration: GDEMU"
          fi
          
          echo "üî® Compiling Source Code..."
          make -j $(nproc)
          
          echo "üíø Packaging CDI..."
          make cdi-prebuilt KOS_BASE=/opt/toolchains/dc/kos

      - name: üì§ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GTA3-Dreamcast-CDI
          path: liberty/*.cdi
          compression-level: 0
