name: Compile DCA3 (Fixed Shell)

on:
  workflow_dispatch:
    inputs:
      game_link:
        description: 'Direct Link to GTA 3 PC Files (.zip, .7z, .rar)'
        required: true
      target_type:
        description: 'Target Media'
        required: true
        default: 'CD-R (Burn)'
        type: choice
        options:
        - 'CD-R (Burn)'
        - 'GDEMU (SD Card)'

jobs:
  build-in-container:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/kos-builds/kos-dc:latest-14.1.0
    
    # CRITICAL FIX: Force all steps to use Bash instead of sh
    defaults:
      run:
        shell: bash

    steps:
      - name: ğŸš€ Prepare Container
        run: |
          apt-get update
          apt-get install -y git cmake genisoimage p7zip-full wget libpng-dev

      - name: ğŸ“¥ Clone GitLab Repo (Beta)
        run: |
          git clone --recursive --branch beta https://gitlab.com/skmp/dca3-game.git .

      - name: âš™ï¸ Patch KOS (Fixed Source Command)
        run: |
          echo "ğŸ”§ Replacing stock KOS with custom dca3-kos..."
          rm -rf /opt/toolchains/dc/kos
          cp -R vendor/dca3-kos /opt/toolchains/dc/kos
          
          # FIX: Use '.' instead of 'source' to be fully compliant
          . /etc/profile.d/kos.sh
          
          echo "Rebuilding Sound Driver..."
          make -C /opt/toolchains/dc/kos/kernel/arch/dreamcast/sound/arm
          
          echo "Rebuilding Kernel..."
          make -C /opt/toolchains/dc/kos -j $(nproc)
          
          echo "Building Utils (makeip & scramble)..."
          make -C /opt/toolchains/dc/kos/utils/makeip
          make -C /opt/toolchains/dc/kos/utils/scramble
          
          # Add utils to PATH for subsequent steps
          echo "/opt/toolchains/dc/kos/utils/makeip" >> $GITHUB_PATH
          echo "/opt/toolchains/dc/kos/utils/scramble" >> $GITHUB_PATH
          
          echo "âœ… Build Environment Fully Patched"

      - name: ğŸ› ï¸ Install Helper Tool (cdi4dc)
        run: |
          git clone --recursive https://github.com/kazade/img4dc.git
          cd img4dc/cdi4dc
          mkdir build && cd build
          cmake .. -Wno-dev
          make
          cp cdi4dc /usr/local/bin/
          echo "âœ… cdi4dc Installed"

      - name: ğŸ® Install User Game Assets
        run: |
          wget -O assets.archive "${{ inputs.game_link }}"
          mkdir temp_extract
          7z x assets.archive -otemp_extract -y
          
          GAME_ROOT=$(find temp_extract -name "gta3.exe" -printf "%h\n" | head -n 1)
          if [ -z "$GAME_ROOT" ]; then GAME_ROOT=$(find temp_extract -type d -name "models" -printf "%h\n" | head -n 1); fi
          
          if [ -z "$GAME_ROOT" ]; then
             echo "âŒ Error: Could not find GTA3 files."
             exit 1
          fi
          
          echo "ğŸ“‚ Copying assets to liberty folder..."
          mkdir -p liberty
          cp -r "$GAME_ROOT"/* liberty/

      - name: ğŸ’¿ Compile Game & CDI
        run: |
          # Load Environment (Using . instead of source)
          . /etc/profile.d/kos.sh
          
          cd liberty
          
          if [ "${{ inputs.target_type }}" == "CD-R (Burn)" ]; then
            export FOR_DISC=1
            echo "ğŸ”¥ Configuration: CD-R (Burn)"
          else
            export FOR_DISC=0
            echo "ğŸ’¾ Configuration: GDEMU"
          fi
          
          echo "ğŸ”¨ Compiling Source Code..."
          make -j $(nproc)
          
          echo "ğŸ’¿ Packaging CDI..."
          # Manually point to the utils we built earlier if they aren't in path
          # We use the absolute paths based on the KOS install
          make cdi-prebuilt KOS_BASE=/opt/toolchains/dc/kos

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GTA3-Dreamcast-CDI
          path: liberty/*.cdi
          compression-level: 0


      - name: âš™ï¸ Patch KOS (Critical Step)
        run: |
          echo "ğŸ”§ Replacing stock KOS with custom dca3-kos..."
          
          # 1. Remove the container's default KOS
          rm -rf /opt/toolchains/dc/kos
          
          # 2. Copy the project's custom KOS into place
          cp -R vendor/dca3-kos /opt/toolchains/dc/kos
          
          # 3. Load KOS Environment Variables
          source /etc/profile.d/kos.sh
          
          # 4. Rebuild the KOS Kernel & Sound Drivers (Matches GitLab CI)
          echo "Rebuilding Sound Driver..."
          make -C /opt/toolchains/dc/kos/kernel/arch/dreamcast/sound/arm
          
          echo "Rebuilding Kernel..."
          make -C /opt/toolchains/dc/kos -j $(nproc)
          
          # 5. Build the Utils (makeip & scramble)
          # These are missing in the base container but required for CDI creation
          echo "Building Utils..."
          make -C /opt/toolchains/dc/kos/utils/makeip
          make -C /opt/toolchains/dc/kos/utils/scramble
          
          echo "âœ… Build Environment Fully Patched"

      - name: ğŸ› ï¸ Install Helper Tool (cdi4dc)
        run: |
          # We need cdi4dc to pack the final disc image
          git clone --recursive https://github.com/kazade/img4dc.git
          cd img4dc/cdi4dc
          mkdir build && cd build
          cmake .. -Wno-dev
          make
          cp cdi4dc /usr/local/bin/
          echo "âœ… cdi4dc Installed"

      - name: ğŸ® Install User Game Assets
        run: |
          wget -O assets.archive "${{ inputs.game_link }}"
          mkdir temp_extract
          7z x assets.archive -otemp_extract -y
          
          # Locate game root
          GAME_ROOT=$(find temp_extract -name "gta3.exe" -printf "%h\n" | head -n 1)
          if [ -z "$GAME_ROOT" ]; then GAME_ROOT=$(find temp_extract -type d -name "models" -printf "%h\n" | head -n 1); fi
          
          if [ -z "$GAME_ROOT" ]; then
             echo "âŒ Error: Could not find GTA3 files."
             exit 1
          fi
          
          echo "ğŸ“‚ Copying assets to liberty folder..."
          mkdir -p liberty
          cp -r "$GAME_ROOT"/* liberty/

      - name: ğŸ’¿ Compile Game & CDI
        run: |
          # Load Environment
          source /etc/profile.d/kos.sh
          cd liberty
          
          # Set Target Type
          if [ "${{ inputs.target_type }}" == "CD-R (Burn)" ]; then
            export FOR_DISC=1
            echo "ğŸ”¥ Configuration: CD-R (Burn)"
          else
            export FOR_DISC=0
            echo "ğŸ’¾ Configuration: GDEMU"
          fi
          
          # 1. Compile the Game (ELF) from Source
          echo "ğŸ”¨ Compiling Source Code..."
          make -j $(nproc)
          
          # 2. Build the Disc Image
          echo "ğŸ’¿ Packaging CDI..."
          make cdi-prebuilt

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GTA3-Dreamcast-CDI
          path: liberty/*.cdi
          compression-level: 0


