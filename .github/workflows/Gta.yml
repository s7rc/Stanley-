name: Compile DCA3 (Fixed GitLab Clone)

on:
  workflow_dispatch:
    inputs:
      game_link:
        description: 'Direct Link to GTA 3 PC Files (.zip, .7z, .rar)'
        required: true
      target_type:
        description: 'Target Media'
        required: true
        default: 'CD-R (Burn)'
        type: choice
        options:
        - 'CD-R (Burn)'
        - 'GDEMU (SD Card)'

jobs:
  build-in-container:
    runs-on: ubuntu-latest
    # Using the official container from their CI
    container:
      image: ghcr.io/kos-builds/kos-dc:latest-14.1.0

    steps:
      - name: üöÄ Prepare Container
        run: |
          # Install Git and tools needed for the build
          apt-get update
          apt-get install -y git cmake genisoimage p7zip-full wget libpng-dev

      - name: üì• Clone GitLab Repo (Beta)
        run: |
          # Manually clone from GitLab to avoid "Repository not found" error
          git clone --recursive --branch beta https://gitlab.com/skmp/dca3-game.git .

      - name: ‚öôÔ∏è Patch KOS (Critical Step)
        run: |
          echo "üîß Replacing stock KOS with custom dca3-kos..."
          
          # 1. Remove the container's default KOS
          rm -rf /opt/toolchains/dc/kos
          
          # 2. Copy the project's custom KOS into place
          cp -R vendor/dca3-kos /opt/toolchains/dc/kos
          
          # 3. Load KOS Environment Variables
          source /etc/profile.d/kos.sh
          
          # 4. Rebuild the KOS Kernel & Sound Drivers (Matches GitLab CI)
          echo "Rebuilding Sound Driver..."
          make -C /opt/toolchains/dc/kos/kernel/arch/dreamcast/sound/arm
          
          echo "Rebuilding Kernel..."
          make -C /opt/toolchains/dc/kos -j $(nproc)
          
          # 5. Build the Utils (makeip & scramble)
          # These are missing in the base container but required for CDI creation
          echo "Building Utils..."
          make -C /opt/toolchains/dc/kos/utils/makeip
          make -C /opt/toolchains/dc/kos/utils/scramble
          
          echo "‚úÖ Build Environment Fully Patched"

      - name: üõ†Ô∏è Install Helper Tool (cdi4dc)
        run: |
          # We need cdi4dc to pack the final disc image
          git clone --recursive https://github.com/kazade/img4dc.git
          cd img4dc/cdi4dc
          mkdir build && cd build
          cmake .. -Wno-dev
          make
          cp cdi4dc /usr/local/bin/
          echo "‚úÖ cdi4dc Installed"

      - name: üéÆ Install User Game Assets
        run: |
          wget -O assets.archive "${{ inputs.game_link }}"
          mkdir temp_extract
          7z x assets.archive -otemp_extract -y
          
          # Locate game root
          GAME_ROOT=$(find temp_extract -name "gta3.exe" -printf "%h\n" | head -n 1)
          if [ -z "$GAME_ROOT" ]; then GAME_ROOT=$(find temp_extract -type d -name "models" -printf "%h\n" | head -n 1); fi
          
          if [ -z "$GAME_ROOT" ]; then
             echo "‚ùå Error: Could not find GTA3 files."
             exit 1
          fi
          
          echo "üìÇ Copying assets to liberty folder..."
          mkdir -p liberty
          cp -r "$GAME_ROOT"/* liberty/

      - name: üíø Compile Game & CDI
        run: |
          # Load Environment
          source /etc/profile.d/kos.sh
          cd liberty
          
          # Set Target Type
          if [ "${{ inputs.target_type }}" == "CD-R (Burn)" ]; then
            export FOR_DISC=1
            echo "üî• Configuration: CD-R (Burn)"
          else
            export FOR_DISC=0
            echo "üíæ Configuration: GDEMU"
          fi
          
          # 1. Compile the Game (ELF) from Source
          echo "üî® Compiling Source Code..."
          make -j $(nproc)
          
          # 2. Build the Disc Image
          echo "üíø Packaging CDI..."
          make cdi-prebuilt

      - name: üì§ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GTA3-Dreamcast-CDI
          path: liberty/*.cdi
          compression-level: 0


