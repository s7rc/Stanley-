name: ğŸŒ TAILSCALE EXIT NODE

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Duration'
        required: true
        default: '6h'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '6h'

jobs:
  VPN-Exit-Node:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: ğŸ“¥ Install & Configure Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          echo "ğŸš€ STARTING VPN EXIT NODE..."
          
          # 1. Install Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # 2. Enable IP Forwarding (Crucial for Exit Nodes)
          echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf
          echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf
          sudo sysctl -p /etc/sysctl.d/99-tailscale.conf
          
          # 3. Connect to Tailscale and advertise as Exit Node
          # --advertise-exit-node: Tells Tailscale this is a router
          # --ssh: Allows you to SSH in if needed
          sudo tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname="github-exit-node-$GITHUB_RUN_ID" --advertise-exit-node --ssh
          
          echo "âœ… Tailscale is UP and RUNNING!"
          echo "ğŸŒ IP Address: $(tailscale ip -4)"

      - name: â³ Keep Session Alive
        run: |
          # Calculate duration in seconds
          DURATION="${{ inputs.duration }}"
          if [ "$DURATION" == "1h" ]; then SECONDS=3600; fi
          if [ "$DURATION" == "3h" ]; then SECONDS=10800; fi
          if [ "$DURATION" == "6h" ]; then SECONDS=21600; fi
          
          END_TIME=$(( $(date +%s) + SECONDS ))
          
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚        ğŸŒ VPN EXIT NODE ACTIVE            â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ 1. Go to your Tailscale Admin Console     â”‚"
          echo "â”‚ 2. Find machine: github-exit-node-...     â”‚"
          echo "â”‚ 3. Click 'Edit route settings'            â”‚"
          echo "â”‚ 4. Check 'Use as exit node'               â”‚"
          echo "â”‚ 5. On your device: Select 'Exit Node'     â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          
          # Loop until time is up
          while [ $(date +%s) -lt $END_TIME ]; do
              REMAINING=$((END_TIME - $(date +%s)))
              printf "\râ³ Keeping VPN Alive... Time remaining: %02dh:%02dm:%02ds" $((REMAINING/3600)) $((REMAINING%3600/60)) $((REMAINING%60))
              sleep 5
          done
          
          echo ""
          echo "ğŸ›‘ Time is up. Shutting down."
          sudo tailscale logout
